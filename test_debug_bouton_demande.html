<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Bouton Demande d'Acc√®s</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-title {
            color: #dc2626;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #dc2626;
            padding-bottom: 5px;
        }
        .debug-step {
            background: #fef2f2;
            margin: 10px 0;
            padding: 15px;
            border-left: 4px solid #dc2626;
            border-radius: 4px;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #b91c1c;
        }
        .code-display {
            background: #1f2937;
            color: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .condition {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug - Bouton Demande d'Acc√®s</h1>
    
    <div class="debug-section">
        <div class="debug-title">üîç Test 1: V√©rification des Conditions d'Affichage</div>
        <div class="debug-step">
            <strong>Condition pour afficher le bouton "Demande d'acc√®s":</strong>
            <br>
            <code>currentUser && createdBy && currentUser !== createdBy</code>
            <br>
            <button onclick="testConditions()">üîç Tester les Conditions</button>
            <div id="result-conditions"></div>
        </div>
    </div>

    <div class="debug-section">
        <div class="debug-title">üë§ Test 2: V√©rification de l'Utilisateur Actuel</div>
        <div class="debug-step">
            <strong>Informations sur l'utilisateur connect√©:</strong>
            <br>
            <button onclick="testCurrentUser()">üë§ V√©rifier Utilisateur Actuel</button>
            <div id="result-current-user"></div>
        </div>
    </div>

    <div class="debug-section">
        <div class="debug-title">üìÑ Test 3: V√©rification des Rapports</div>
        <div class="debug-step">
            <strong>Liste des rapports et leurs propri√©taires:</strong>
            <br>
            <button onclick="testReports()">üìÑ V√©rifier les Rapports</button>
            <div id="result-reports"></div>
        </div>
    </div>

    <div class="debug-section">
        <div class="debug-title">üîß Test 4: Solutions de Correction</div>
        <div class="debug-step">
            <strong>Solutions pour forcer l'affichage du bouton:</strong>
            <br>
            <button onclick="testSolutions()">üîß Proposer des Solutions</button>
            <div id="result-solutions"></div>
        </div>
    </div>

    <div class="debug-section">
        <div class="debug-title">üß™ Test 5: Simulation du Workflow</div>
        <div class="debug-step">
            <strong>Simulation compl√®te du workflow de demande d'acc√®s:</strong>
            <br>
            <button onclick="testWorkflow()">üß™ Simuler le Workflow</button>
            <div id="result-workflow"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        // Test 1: V√©rification des Conditions
        function testConditions() {
            const resultDiv = document.getElementById('result-conditions');
            resultDiv.innerHTML = '<div class="info">Test en cours...</div>';

            try {
                // Simuler les valeurs typiques
                const testCases = [
                    {
                        name: 'Utilisateur normal, rapport d\'un autre utilisateur',
                        currentUser: 'John Doe',
                        createdBy: 'Jane Smith',
                        expected: true,
                        description: 'Le bouton devrait appara√Ætre'
                    },
                    {
                        name: 'Utilisateur propri√©taire de son rapport',
                        currentUser: 'John Doe',
                        createdBy: 'John Doe',
                        expected: false,
                        description: 'Le bouton ne devrait pas appara√Ætre'
                    },
                    {
                        name: 'Utilisateur non d√©fini',
                        currentUser: null,
                        createdBy: 'Jane Smith',
                        expected: false,
                        description: 'Le bouton ne devrait pas appara√Ætre'
                    },
                    {
                        name: 'Rapport sans propri√©taire',
                        currentUser: 'John Doe',
                        createdBy: null,
                        expected: false,
                        description: 'Le bouton ne devrait pas appara√Ætre'
                    }
                ];

                let results = '';
                testCases.forEach(testCase => {
                    const condition = testCase.currentUser && testCase.createdBy && testCase.currentUser !== testCase.createdBy;
                    const isCorrect = condition === testCase.expected;
                    
                    results += `
                        <div class="condition">
                            <strong>${testCase.name}:</strong>
                            <br>üë§ Utilisateur actuel: ${testCase.currentUser || 'null'}
                            <br>üìÑ Cr√©√© par: ${testCase.createdBy || 'null'}
                            <br>üîç Condition: ${testCase.currentUser && testCase.createdBy && testCase.currentUser !== testCase.createdBy ? 'true' : 'false'}
                            <br>üìù ${testCase.description}
                            <br>${isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}
                        </div>
                    `;
                });

                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Test des conditions termin√©</div>
                    ${results}
                    <div class="info">
                        üí° Le bouton "Demande d'acc√®s" n'appara√Æt que si :
                        <br>‚Ä¢ L'utilisateur est connect√© (currentUser existe)
                        <br>‚Ä¢ Le rapport a un propri√©taire (createdBy existe)
                        <br>‚Ä¢ L'utilisateur n'est PAS le propri√©taire (currentUser !== createdBy)
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Test 2: V√©rification de l'Utilisateur Actuel
        function testCurrentUser() {
            const resultDiv = document.getElementById('result-current-user');
            resultDiv.innerHTML = '<div class="info">Test en cours...</div>';

            try {
                // Simuler la r√©cup√©ration de l'utilisateur depuis localStorage
                const userFromStorage = localStorage.getItem('user');
                let user = null;
                
                if (userFromStorage) {
                    try {
                        user = JSON.parse(userFromStorage);
                    } catch (e) {
                        console.error('Erreur parsing user:', e);
                    }
                }

                // Simuler l'utilisateur par d√©faut si aucun n'est trouv√©
                if (!user) {
                    user = {
                        name: 'Utilisateur Test',
                        email: 'test@example.com',
                        company: 'Company Test'
                    };
                }

                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Informations utilisateur r√©cup√©r√©es</div>
                    <div class="code-display">
                        Utilisateur actuel:
                        ${JSON.stringify(user, null, 2)}
                    </div>
                    <div class="info">
                        üìã D√©tails:
                        <br>‚Ä¢ Nom: ${user.name || 'Non d√©fini'}
                        <br>‚Ä¢ Email: ${user.email || 'Non d√©fini'}
                        <br>‚Ä¢ Compagnie: ${user.company || 'Non d√©fini'}
                        <br>‚Ä¢ Source: ${userFromStorage ? 'localStorage' : 'Valeurs par d√©faut'}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Test 3: V√©rification des Rapports
        async function testReports() {
            const resultDiv = document.getElementById('result-reports');
            resultDiv.innerHTML = '<div class="info">Test en cours...</div>';

            try {
                // Simuler des rapports de test
                const testReports = [
                    {
                        id: 1,
                        title: 'Rapport de Test 1',
                        createdBy: 'John Doe',
                        status: 'Disponible'
                    },
                    {
                        id: 2,
                        title: 'Rapport de Test 2',
                        createdBy: 'Jane Smith',
                        status: 'Disponible'
                    },
                    {
                        id: 3,
                        title: 'Rapport de Test 3',
                        createdBy: null,
                        status: 'Disponible'
                    }
                ];

                const currentUser = 'John Doe'; // Simuler l'utilisateur actuel

                let results = '';
                testReports.forEach(report => {
                    const shouldShowButton = currentUser && report.createdBy && currentUser !== report.createdBy;
                    
                    results += `
                        <div class="condition">
                            <strong>Rapport ${report.id}:</strong> ${report.title}
                            <br>üë§ Cr√©√© par: ${report.createdBy || 'Non d√©fini'}
                            <br>üë§ Utilisateur actuel: ${currentUser}
                            <br>üîç Bouton "Demande d'acc√®s": ${shouldShowButton ? '‚úÖ Visible' : '‚ùå Masqu√©'}
                            <br>üìù Raison: ${!report.createdBy ? 'Pas de propri√©taire' : currentUser === report.createdBy ? 'Propri√©taire du rapport' : 'Utilisateur diff√©rent'}
                        </div>
                    `;
                });

                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Analyse des rapports termin√©e</div>
                    ${results}
                    <div class="info">
                        üí° Pour voir le bouton "Demande d'acc√®s":
                        <br>‚Ä¢ Les rapports doivent avoir un propri√©taire (createdBy)
                        <br>‚Ä¢ L'utilisateur actuel ne doit pas √™tre le propri√©taire
                        <br>‚Ä¢ L'utilisateur doit √™tre connect√©
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Test 4: Solutions de Correction
        function testSolutions() {
            const resultDiv = document.getElementById('result-solutions');
            resultDiv.innerHTML = '<div class="info">Analyse en cours...</div>';

            try {
                const solutions = [
                    {
                        problem: 'Aucun utilisateur connect√©',
                        solution: 'Se connecter ou cr√©er un utilisateur par d√©faut',
                        code: `
// Dans Reports.tsx, ajouter un utilisateur par d√©faut
const defaultUser = {
    name: 'Utilisateur Test',
    email: 'test@example.com',
    company: 'Company Test'
};
const currentUser = user.name || defaultUser.name;
                        `
                    },
                    {
                        problem: 'Rapports sans propri√©taire (createdBy = null)',
                        solution: 'Attribuer un propri√©taire aux rapports existants',
                        code: `
// Mettre √† jour les rapports existants
UPDATE reports SET created_by = 'Admin User' WHERE created_by IS NULL;
                        `
                    },
                    {
                        problem: 'Utilisateur propri√©taire de tous les rapports',
                        solution: 'Cr√©er des rapports avec diff√©rents propri√©taires',
                        code: `
// Cr√©er des rapports de test avec diff√©rents propri√©taires
const testReports = [
    { title: 'Rapport Admin', createdBy: 'Admin User' },
    { title: 'Rapport Manager', createdBy: 'Manager User' },
    { title: 'Rapport Analyst', createdBy: 'Analyst User' }
];
                        `
                    },
                    {
                        problem: 'Condition trop restrictive',
                        solution: 'Modifier temporairement la condition pour les tests',
                        code: `
// Dans ReportCard.tsx, modifier temporairement
{/* Version de test - toujours afficher le bouton */}
<Button intent="secondary" onClick={onRequestAccess}>üîê Demande d'acc√®s</Button>

{/* Version finale - condition normale */}
{currentUser && createdBy && currentUser !== createdBy ? (
    <Button intent="secondary" onClick={onRequestAccess}>üîê Demande d'acc√®s</Button>
) : (
    <Button intent={unavailable ? 'secondary' : 'primary'} disabled={unavailable} onClick={onDownload}>T√©l√©charger</Button>
)}
                        `
                    }
                ];

                let solutionsHtml = '';
                solutions.forEach((sol, index) => {
                    solutionsHtml += `
                        <div class="condition">
                            <strong>Solution ${index + 1}:</strong> ${sol.problem}
                            <br>üîß ${sol.solution}
                            <div class="code-display">${sol.code}</div>
                        </div>
                    `;
                });

                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Solutions identifi√©es</div>
                    ${solutionsHtml}
                    <div class="info">
                        üéØ Recommandations:
                        <br>‚Ä¢ V√©rifier que l'utilisateur est connect√©
                        <br>‚Ä¢ S'assurer que les rapports ont des propri√©taires
                        <br>‚Ä¢ Cr√©er des rapports avec diff√©rents propri√©taires
                        <br>‚Ä¢ Tester avec des utilisateurs diff√©rents
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Test 5: Simulation du Workflow
        function testWorkflow() {
            const resultDiv = document.getElementById('result-workflow');
            resultDiv.innerHTML = '<div class="info">Simulation en cours...</div>';

            try {
                const workflowSteps = [
                    {
                        step: 1,
                        action: 'V√©rifier l\'utilisateur connect√©',
                        status: 'completed',
                        details: 'Utilisateur: John Doe'
                    },
                    {
                        step: 2,
                        action: 'Identifier les rapports d\'autres utilisateurs',
                        status: 'completed',
                        details: 'Rapport cr√©√© par: Jane Smith'
                    },
                    {
                        step: 3,
                        action: 'Afficher le bouton "Demande d\'acc√®s"',
                        status: 'completed',
                        details: 'Condition: currentUser !== createdBy ‚úÖ'
                    },
                    {
                        step: 4,
                        action: 'Clic sur le bouton',
                        status: 'pending',
                        details: 'Ouvre le modal de demande'
                    },
                    {
                        step: 5,
                        action: 'Remplir le formulaire',
                        status: 'pending',
                        details: 'Email, compagnie, t√©l√©phone, motif'
                    },
                    {
                        step: 6,
                        action: 'Soumettre la demande',
                        status: 'pending',
                        details: 'Cr√©ation en base de donn√©es'
                    },
                    {
                        step: 7,
                        action: 'Notification admin',
                        status: 'pending',
                        details: 'Admin re√ßoit la notification'
                    },
                    {
                        step: 8,
                        action: 'Approbation admin',
                        status: 'pending',
                        details: 'G√©n√©ration du code temporaire'
                    },
                    {
                        step: 9,
                        action: 'Notification utilisateur',
                        status: 'pending',
                        details: 'R√©ception du code par email/SMS'
                    },
                    {
                        step: 10,
                        action: 'T√©l√©chargement',
                        status: 'pending',
                        details: 'Validation du code et t√©l√©chargement'
                    }
                ];

                let workflowHtml = '';
                workflowSteps.forEach(step => {
                    const statusClass = step.status === 'completed' ? 'success' : step.status === 'pending' ? 'info' : 'error';
                    workflowHtml += `
                        <div class="condition">
                            <strong>√âtape ${step.step}:</strong> ${step.action}
                            <br>üìä Statut: ${step.status === 'completed' ? '‚úÖ Termin√©' : step.status === 'pending' ? '‚è≥ En attente' : '‚ùå √âchec'}
                            <br>üìù ${step.details}
                        </div>
                    `;
                });

                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Simulation du workflow termin√©e</div>
                    ${workflowHtml}
                    <div class="info">
                        üéØ Workflow complet:
                        <br>‚Ä¢ Les √©tapes 1-3 sont automatiques (interface)
                        <br>‚Ä¢ Les √©tapes 4-6 sont manuelles (utilisateur)
                        <br>‚Ä¢ Les √©tapes 7-8 sont administratives
                        <br>‚Ä¢ Les √©tapes 9-10 sont automatiques (notifications)
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
