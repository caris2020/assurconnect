<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Codes Admin</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .info { border-left: 4px solid #17a2b8; }
        button { padding: 12px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        input, select { padding: 10px; margin: 5px; width: 200px; border: 1px solid #ddd; border-radius: 4px; }
        .result { margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid #6c757d; }
        .result.success { background-color: #d4edda; border-color: #28a745; }
        .result.error { background-color: #f8d7da; border-color: #dc3545; }
        .result.info { background-color: #d1ecf1; border-color: #17a2b8; }
        .log { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin-top: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .code-display { font-family: monospace; background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Codes Admin</h1>
        
        <div class="test-section info">
            <h3>üìã Probl√®me Identifi√©</h3>
            <p>Les codes fournis depuis la page admin ne fonctionnaient pas car :</p>
            <ul>
                <li>‚ùå <strong>Avant :</strong> G√©n√©ration bas√©e sur un hash du titre du rapport</li>
                <li>‚ùå <strong>Probl√®me :</strong> Les IDs simul√©s ne correspondaient pas aux vrais IDs</li>
                <li>‚úÖ <strong>Solution :</strong> Utilisation des vrais IDs des rapports</li>
                <li>‚úÖ <strong>R√©sultat :</strong> Codes coh√©rents entre admin et t√©l√©chargement</li>
            </ul>
        </div>

        <div class="comparison">
            <!-- Test 1: Codes Admin -->
            <div class="test-section">
                <h3>üîê Test 1: Codes depuis Admin</h3>
                <p>Test de r√©cup√©ration des codes depuis la page admin</p>
                
                <label>ID du Rapport: <input type="number" id="adminReportId" value="1" min="1"></label><br>
                <label>Utilisateur: <input type="text" id="adminUser" value="admin"></label><br>
                
                <button class="btn-primary" onclick="testAdminCodes()">R√©cup√©rer Codes Admin</button>
                <button class="btn-success" onclick="testAdminValidation()">Tester Validation</button>
                
                <div id="adminCodesResult" class="result" style="display: none;"></div>
                <div id="adminCodes" class="code-display" style="display: none;"></div>
            </div>

            <!-- Test 2: Codes Frontend -->
            <div class="test-section">
                <h3>üì± Test 2: Codes Frontend</h3>
                <p>Test de g√©n√©ration des codes c√¥t√© frontend</p>
                
                <label>ID du Rapport: <input type="number" id="frontendReportId" value="1" min="1"></label><br>
                
                <button class="btn-primary" onclick="testFrontendCodes()">G√©n√©rer Codes Frontend</button>
                <button class="btn-success" onclick="testFrontendValidation()">Tester Validation</button>
                
                <div id="frontendCodesResult" class="result" style="display: none;"></div>
                <div id="frontendCodes" class="code-display" style="display: none;"></div>
            </div>
        </div>

        <!-- Test 3: Comparaison -->
        <div class="test-section">
            <h3>üîç Test 3: Comparaison des Codes</h3>
            <p>V√©rification de la coh√©rence entre admin et frontend</p>
            
            <button class="btn-warning" onclick="compareCodes()">Comparer les Codes</button>
            <button class="btn-success" onclick="testCompleteFlow()">Test Flux Complet</button>
            
            <div id="comparisonResult" class="result" style="display: none;"></div>
        </div>

        <!-- Test 4: Validation et T√©l√©chargement -->
        <div class="test-section">
            <h3>üì• Test 4: Validation et T√©l√©chargement</h3>
            <p>Test complet avec validation et t√©l√©chargement</p>
            
            <label>ID du Rapport: <input type="number" id="downloadReportId" value="1" min="1"></label><br>
            <label>Code d'Acc√®s: <input type="text" id="downloadCode" placeholder="Ex: CODE000001"></label><br>
            <label>Utilisateur: <input type="text" id="downloadUser" value="testuser"></label><br>
            
            <button class="btn-primary" onclick="generateDownloadCode()">G√©n√©rer Code</button>
            <button class="btn-success" onclick="testDownloadValidation()">Valider Code</button>
            <button class="btn-warning" onclick="testDownload()">T√©l√©charger</button>
            
            <div id="downloadResult" class="result" style="display: none;"></div>
        </div>

        <!-- Log des actions -->
        <div class="test-section">
            <h3>üìù Log des Actions</h3>
            <div id="actionLog" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let adminCodes = [];
        let frontendCodes = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('actionLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testAdminCodes() {
            const reportId = document.getElementById('adminReportId').value;
            const user = document.getElementById('adminUser').value;
            const resultDiv = document.getElementById('adminCodesResult');
            const codesDiv = document.getElementById('adminCodes');
            
            try {
                log(`R√©cup√©ration des codes admin pour le rapport ${reportId}...`);
                
                const response = await fetch(`${API_BASE}/api/download/files/${reportId}?requesterName=${encodeURIComponent(user)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    adminCodes = data.map((file: any) => file.accessCode).filter(Boolean);
                    
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Codes admin r√©cup√©r√©s</h4>
                        <p><strong>Nombre de codes:</strong> ${adminCodes.length}</p>
                        <p><strong>Rapport ID:</strong> ${reportId}</p>
                    `;
                    
                    codesDiv.style.display = 'block';
                    codesDiv.innerHTML = `<strong>Codes Admin:</strong><br>${adminCodes.map(code => `<code>${code}</code>`).join('<br>')}`;
                    
                    log(`Codes admin r√©cup√©r√©s: ${adminCodes.join(', ')}`, 'success');
                } else {
                    const errorText = await response.text();
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<h4>‚ùå Erreur</h4><p>${errorText}</p>`;
                    log(`Erreur r√©cup√©ration codes admin: ${errorText}`, 'error');
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Erreur</h4><p>${error.message}</p>`;
                log(`Erreur lors de la r√©cup√©ration des codes admin: ${error.message}`, 'error');
            }
        }

        async function testAdminValidation() {
            if (adminCodes.length === 0) {
                alert('Veuillez d\'abord r√©cup√©rer les codes admin');
                return;
            }
            
            const reportId = document.getElementById('adminReportId').value;
            const code = adminCodes[0]; // Prendre le premier code
            
            try {
                log(`Validation du code admin ${code} pour le rapport ${reportId}...`);
                
                const response = await fetch(`${API_BASE}/api/download/validate-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId: parseInt(reportId), code: code })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    log(`‚úÖ Code admin ${code} valid√© avec succ√®s`, 'success');
                } else {
                    log(`‚ùå Code admin ${code} invalide`, 'error');
                }
            } catch (error) {
                log(`Erreur lors de la validation du code admin: ${error.message}`, 'error');
            }
        }

        function testFrontendCodes() {
            const reportId = document.getElementById('frontendReportId').value;
            const resultDiv = document.getElementById('frontendCodesResult');
            const codesDiv = document.getElementById('frontendCodes');
            
            // G√©n√©rer le code comme le fait le frontend
            const code = `CODE${reportId.toString().padStart(6, '0')}`;
            frontendCodes = [code];
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `
                <h4>‚úÖ Code frontend g√©n√©r√©</h4>
                <p><strong>Code g√©n√©r√©:</strong> ${code}</p>
                <p><strong>Rapport ID:</strong> ${reportId}</p>
            `;
            
            codesDiv.style.display = 'block';
            codesDiv.innerHTML = `<strong>Code Frontend:</strong><br><code>${code}</code>`;
            
            log(`Code frontend g√©n√©r√©: ${code}`, 'success');
        }

        async function testFrontendValidation() {
            if (frontendCodes.length === 0) {
                alert('Veuillez d\'abord g√©n√©rer le code frontend');
                return;
            }
            
            const reportId = document.getElementById('frontendReportId').value;
            const code = frontendCodes[0];
            
            try {
                log(`Validation du code frontend ${code} pour le rapport ${reportId}...`);
                
                const response = await fetch(`${API_BASE}/api/download/validate-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId: parseInt(reportId), code: code })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    log(`‚úÖ Code frontend ${code} valid√© avec succ√®s`, 'success');
                } else {
                    log(`‚ùå Code frontend ${code} invalide`, 'error');
                }
            } catch (error) {
                log(`Erreur lors de la validation du code frontend: ${error.message}`, 'error');
            }
        }

        function compareCodes() {
            const resultDiv = document.getElementById('comparisonResult');
            
            if (adminCodes.length === 0 || frontendCodes.length === 0) {
                alert('Veuillez d\'abord r√©cup√©rer les codes admin et g√©n√©rer les codes frontend');
                return;
            }
            
            const adminReportId = document.getElementById('adminReportId').value;
            const frontendReportId = document.getElementById('frontendReportId').value;
            
            resultDiv.style.display = 'block';
            
            if (adminReportId === frontendReportId) {
                // M√™me rapport, les codes devraient √™tre identiques
                const adminCode = adminCodes[0];
                const frontendCode = frontendCodes[0];
                
                if (adminCode === frontendCode) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Codes identiques</h4>
                        <p><strong>Code admin:</strong> ${adminCode}</p>
                        <p><strong>Code frontend:</strong> ${frontendCode}</p>
                        <p><strong>Rapport ID:</strong> ${adminReportId}</p>
                        <p>üéâ Les codes sont coh√©rents !</p>
                    `;
                    log('‚úÖ Codes admin et frontend identiques', 'success');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>‚ùå Codes diff√©rents</h4>
                        <p><strong>Code admin:</strong> ${adminCode}</p>
                        <p><strong>Code frontend:</strong> ${frontendCode}</p>
                        <p><strong>Rapport ID:</strong> ${adminReportId}</p>
                        <p>‚ö†Ô∏è Les codes ne correspondent pas !</p>
                    `;
                    log('‚ùå Codes admin et frontend diff√©rents', 'error');
                }
            } else {
                resultDiv.className = 'result info';
                resultDiv.innerHTML = `
                    <h4>‚ÑπÔ∏è Rapports diff√©rents</h4>
                    <p><strong>Rapport admin:</strong> ${adminReportId}</p>
                    <p><strong>Rapport frontend:</strong> ${frontendReportId}</p>
                    <p>Les codes ne peuvent pas √™tre compar√©s car les rapports sont diff√©rents.</p>
                `;
                log('‚ÑπÔ∏è Rapports diff√©rents, comparaison impossible', 'info');
            }
        }

        async function testCompleteFlow() {
            log('üß™ D√©but du test de flux complet...', 'info');
            
            // Test 1: R√©cup√©rer les codes admin
            await testAdminCodes();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 2: G√©n√©rer les codes frontend
            testFrontendCodes();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 3: Comparer les codes
            compareCodes();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 4: Valider les codes
            await testAdminValidation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testFrontendValidation();
            
            log('üß™ Test de flux complet termin√©', 'info');
        }

        function generateDownloadCode() {
            const reportId = document.getElementById('downloadReportId').value;
            const code = `CODE${reportId.toString().padStart(6, '0')}`;
            document.getElementById('downloadCode').value = code;
            log(`Code de t√©l√©chargement g√©n√©r√©: ${code}`, 'success');
        }

        async function testDownloadValidation() {
            const reportId = document.getElementById('downloadReportId').value;
            const code = document.getElementById('downloadCode').value;
            const resultDiv = document.getElementById('downloadResult');
            
            try {
                log(`Validation du code de t√©l√©chargement ${code}...`);
                
                const response = await fetch(`${API_BASE}/api/download/validate-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId: parseInt(reportId), code: code })
                });
                
                const data = await response.json();
                
                resultDiv.style.display = 'block';
                
                if (data.valid) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Code de t√©l√©chargement valide</h4>
                        <p><strong>Code:</strong> ${code}</p>
                        <p><strong>Rapport ID:</strong> ${reportId}</p>
                        <p>Le t√©l√©chargement peut maintenant √™tre effectu√©.</p>
                    `;
                    log(`‚úÖ Code de t√©l√©chargement ${code} valid√©`, 'success');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>‚ùå Code de t√©l√©chargement invalide</h4>
                        <p><strong>Code fourni:</strong> ${code}</p>
                        <p><strong>Code attendu:</strong> ${data.expectedCode}</p>
                        <p><strong>Erreur:</strong> ${data.error || 'Code invalide'}</p>
                    `;
                    log(`‚ùå Code de t√©l√©chargement ${code} invalide`, 'error');
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Erreur</h4><p>${error.message}</p>`;
                log(`Erreur lors de la validation: ${error.message}`, 'error');
            }
        }

        async function testDownload() {
            const reportId = document.getElementById('downloadReportId').value;
            const code = document.getElementById('downloadCode').value;
            const user = document.getElementById('downloadUser').value;
            const resultDiv = document.getElementById('downloadResult');
            
            try {
                log(`Tentative de t√©l√©chargement avec le code ${code}...`);
                
                const response = await fetch(`${API_BASE}/api/download/${reportId}?requesterName=${encodeURIComponent(user)}&code=${encodeURIComponent(code)}`);
                
                if (response.ok) {
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ T√©l√©chargement r√©ussi</h4>
                        <p><strong>Code utilis√©:</strong> ${code}</p>
                        <p><strong>Rapport ID:</strong> ${reportId}</p>
                        <p>Le fichier devrait se t√©l√©charger automatiquement.</p>
                    `;
                    log('‚úÖ T√©l√©chargement r√©ussi', 'success');
                    
                    // D√©clencher le t√©l√©chargement
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rapport_${reportId}.bin`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    const errorText = await response.text();
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>‚ùå T√©l√©chargement √©chou√©</h4>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Erreur:</strong> ${errorText}</p>
                    `;
                    log(`T√©l√©chargement √©chou√©: ${errorText}`, 'error');
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Erreur</h4><p>${error.message}</p>`;
                log(`Erreur lors du t√©l√©chargement: ${error.message}`, 'error');
            }
        }

        // Initialisation
        window.onload = function() {
            log('üß™ Syst√®me de test des codes admin initialis√©', 'info');
            generateDownloadCode(); // G√©n√©rer un code par d√©faut
        };
    </script>
</body>
</html>
