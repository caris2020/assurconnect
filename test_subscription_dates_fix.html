<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Correction des dates d'expiration d'abonnement</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .user-table th, .user-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .user-table th {
            background-color: #f2f2f2;
        }
        .expired {
            color: red;
            font-weight: bold;
        }
        .expiring-soon {
            color: orange;
            font-weight: bold;
        }
        .active {
            color: green;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test - Correction des dates d'expiration d'abonnement</h1>
        
        <div class="test-section info">
            <h3>üìã Description du probl√®me</h3>
            <p>Le probl√®me √©tait que les dates d'expiration d'abonnement dans le tableau de bord administrateur affichaient des dates futures incorrectes (2026, 2027) au lieu des vraies dates d'expiration.</p>
            <p><strong>Cause :</strong> Dans le backend, les m√©thodes <code>isSubscriptionExpired()</code> et <code>getDaysUntilExpiration()</code> utilisaient une date fixe <code>LocalDate.of(2025, 8, 27)</code> au lieu de la date actuelle r√©elle.</p>
            <p><strong>Solution :</strong> Remplacement de la date fixe par <code>LocalDate.now()</code> pour utiliser la date actuelle r√©elle.</p>
        </div>

        <div class="test-section">
            <h3>üß™ Tests √† effectuer</h3>
            <button onclick="testCurrentDate()">1. V√©rifier la date actuelle du syst√®me</button>
            <button onclick="testUserSubscriptions()">2. Tester les abonnements utilisateurs</button>
            <button onclick="testAdminSubscription()">3. Tester l'abonnement administrateur</button>
            <button onclick="testExpiredSubscriptions()">4. Tester les abonnements expir√©s</button>
        </div>

        <div id="results"></div>

        <div class="test-section">
            <h3>üìä R√©sultats des tests</h3>
            <div id="userResults"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';

        function displayResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            resultsDiv.appendChild(div);
        }

        async function testCurrentDate() {
            try {
                displayResult('üîç Test de la date actuelle du syst√®me...', 'info');
                
                const now = new Date();
                const currentDate = now.toLocaleDateString('fr-FR');
                const currentTime = now.toLocaleTimeString('fr-FR');
                
                displayResult(`‚úÖ Date actuelle : ${currentDate} √† ${currentTime}`, 'success');
                
                // V√©rifier que la date n'est pas dans le futur
                const currentYear = now.getFullYear();
                if (currentYear > 2025) {
                    displayResult(`‚ö†Ô∏è Attention : L'ann√©e actuelle (${currentYear}) est dans le futur par rapport √† 2025`, 'error');
                } else {
                    displayResult(`‚úÖ L'ann√©e actuelle (${currentYear}) est coh√©rente`, 'success');
                }
                
            } catch (error) {
                displayResult(`‚ùå Erreur lors du test de la date : ${error.message}`, 'error');
            }
        }

        async function testUserSubscriptions() {
            try {
                displayResult('üîç Test des abonnements utilisateurs...', 'info');
                
                const response = await fetch(`${API_BASE}/users`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const users = await response.json();
                displayResult(`‚úÖ ${users.length} utilisateurs r√©cup√©r√©s`, 'success');
                
                const userResultsDiv = document.getElementById('userResults');
                userResultsDiv.innerHTML = `
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Compagnie</th>
                                <th>R√¥le</th>
                                <th>Date de fin d'abonnement</th>
                                <th>Jours restants</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => {
                                const endDate = user.subscriptionEndDate ? new Date(user.subscriptionEndDate) : null;
                                const daysLeft = user.daysUntilExpiration;
                                let statusClass = 'active';
                                let statusText = 'Actif';
                                
                                if (user.role === 'ADMIN') {
                                    statusClass = 'active';
                                    statusText = 'Administrateur (permanent)';
                                } else if (daysLeft <= 0) {
                                    statusClass = 'expired';
                                    statusText = 'Expir√©';
                                } else if (daysLeft <= 30) {
                                    statusClass = 'expiring-soon';
                                    statusText = 'Expiration proche';
                                }
                                
                                return `
                                    <tr>
                                        <td>${user.firstName} ${user.lastName}</td>
                                        <td>${user.insuranceCompany}</td>
                                        <td>${user.role}</td>
                                        <td>${endDate ? endDate.toLocaleDateString('fr-FR') : 'Non d√©fini'}</td>
                                        <td>${user.role === 'ADMIN' ? '‚àû' : daysLeft}</td>
                                        <td class="${statusClass}">${statusText}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                
                // V√©rifier les incoh√©rences
                const issues = [];
                users.forEach(user => {
                    if (user.role !== 'ADMIN' && user.subscriptionEndDate) {
                        const endDate = new Date(user.subscriptionEndDate);
                        const now = new Date();
                        
                        // V√©rifier si la date de fin est dans le futur lointain (plus de 2 ans)
                        const twoYearsFromNow = new Date();
                        twoYearsFromNow.setFullYear(twoYearsFromNow.getFullYear() + 2);
                        
                        if (endDate > twoYearsFromNow) {
                            issues.push(`${user.firstName} ${user.lastName} : Date de fin dans le futur lointain (${endDate.toLocaleDateString('fr-FR')})`);
                        }
                        
                        // V√©rifier la coh√©rence entre la date de fin et les jours restants
                        const expectedDaysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                        if (Math.abs(expectedDaysLeft - user.daysUntilExpiration) > 1) {
                            issues.push(`${user.firstName} ${user.lastName} : Incoh√©rence entre date de fin et jours restants (attendu: ${expectedDaysLeft}, obtenu: ${user.daysUntilExpiration})`);
                        }
                    }
                });
                
                if (issues.length > 0) {
                    displayResult(`‚ö†Ô∏è Probl√®mes d√©tect√©s :<br>${issues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}`, 'error');
                } else {
                    displayResult('‚úÖ Aucune incoh√©rence d√©tect√©e dans les dates d\'abonnement', 'success');
                }
                
            } catch (error) {
                displayResult(`‚ùå Erreur lors du test des abonnements : ${error.message}`, 'error');
            }
        }

        async function testAdminSubscription() {
            try {
                displayResult('üîç Test de l\'abonnement administrateur...', 'info');
                
                const response = await fetch(`${API_BASE}/users`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const users = await response.json();
                const adminUser = users.find(user => user.role === 'ADMIN');
                
                if (adminUser) {
                    if (adminUser.daysUntilExpiration === Number.MAX_SAFE_INTEGER || adminUser.daysUntilExpiration > 1000000) {
                        displayResult('‚úÖ L\'administrateur a un abonnement permanent (jours restants infinis)', 'success');
                    } else {
                        displayResult(`‚ö†Ô∏è L'administrateur a un nombre de jours restants limit√© : ${adminUser.daysUntilExpiration}`, 'error');
                    }
                    
                    if (!adminUser.subscriptionEndDate) {
                        displayResult('‚úÖ L\'administrateur n\'a pas de date de fin d\'abonnement', 'success');
                    } else {
                        displayResult(`‚ö†Ô∏è L'administrateur a une date de fin d'abonnement : ${adminUser.subscriptionEndDate}`, 'error');
                    }
                } else {
                    displayResult('‚ö†Ô∏è Aucun utilisateur administrateur trouv√©', 'error');
                }
                
            } catch (error) {
                displayResult(`‚ùå Erreur lors du test de l'abonnement administrateur : ${error.message}`, 'error');
            }
        }

        async function testExpiredSubscriptions() {
            try {
                displayResult('üîç Test des abonnements expir√©s...', 'info');
                
                const response = await fetch(`${API_BASE}/users`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const users = await response.json();
                const expiredUsers = users.filter(user => 
                    user.role !== 'ADMIN' && 
                    user.daysUntilExpiration <= 0
                );
                
                if (expiredUsers.length > 0) {
                    displayResult(`‚úÖ ${expiredUsers.length} utilisateur(s) avec abonnement expir√© :`, 'success');
                    expiredUsers.forEach(user => {
                        displayResult(`‚Ä¢ ${user.firstName} ${user.lastName} (${user.insuranceCompany}) - ${user.daysUntilExpiration} jours restants`, 'info');
                    });
                } else {
                    displayResult('‚ÑπÔ∏è Aucun utilisateur avec abonnement expir√©', 'info');
                }
                
                // V√©rifier les utilisateurs avec expiration proche (moins de 30 jours)
                const expiringSoonUsers = users.filter(user => 
                    user.role !== 'ADMIN' && 
                    user.daysUntilExpiration > 0 && 
                    user.daysUntilExpiration <= 30
                );
                
                if (expiringSoonUsers.length > 0) {
                    displayResult(`‚ö†Ô∏è ${expiringSoonUsers.length} utilisateur(s) avec expiration proche :`, 'error');
                    expiringSoonUsers.forEach(user => {
                        displayResult(`‚Ä¢ ${user.firstName} ${user.lastName} (${user.insuranceCompany}) - ${user.daysUntilExpiration} jours restants`, 'info');
                    });
                }
                
            } catch (error) {
                displayResult(`‚ùå Erreur lors du test des abonnements expir√©s : ${error.message}`, 'error');
            }
        }

        // Test automatique au chargement de la page
        window.onload = function() {
            displayResult('üöÄ D√©marrage des tests automatiques...', 'info');
            setTimeout(() => testCurrentDate(), 1000);
            setTimeout(() => testUserSubscriptions(), 2000);
            setTimeout(() => testAdminSubscription(), 3000);
            setTimeout(() => testExpiredSubscriptions(), 4000);
        };
    </script>
</body>
</html>
