<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Restriction Propri√©t√© Dossier pour Cr√©ation Rapport</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .form-simulation { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background: #f9f9f9; }
        .input-field { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin: 5px 0; }
        .error-message { color: #dc3545; font-size: 12px; margin-top: 5px; }
        .warning-message { color: #fd7e14; font-size: 12px; margin-top: 5px; }
        .user-role { background: #e3f2fd; padding: 5px; border-radius: 3px; font-family: monospace; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .test-button { background: #3b82f6; color: white; border: none; border-radius: 6px; }
        .simulate-button { background: #10b981; color: white; border: none; border-radius: 6px; }
        .restriction-button { background: #f59e0b; color: white; border: none; border-radius: 6px; }
    </style>
</head>
<body>
    <h1>Test Restriction Propri√©t√© Dossier pour Cr√©ation Rapport</h1>
    
    <div class="test-section info">
        <h3>Objectif de la Restriction</h3>
        <p>Impl√©menter une restriction qui emp√™che un utilisateur de cr√©er un rapport pour un dossier dont il n'est pas propri√©taire :</p>
        <ul>
            <li>‚úÖ <strong>Champ de saisie libre</strong> : L'utilisateur peut saisir le num√©ro de dossier manuellement</li>
            <li>‚úÖ <strong>V√©rification des permissions</strong> : V√©rifier que l'utilisateur est propri√©taire du dossier</li>
            <li>‚úÖ <strong>Messages d'erreur sp√©cifiques</strong> : "Dossier inexistant" ou "Permissions insuffisantes"</li>
            <li>‚úÖ <strong>Validation en temps r√©el</strong> : V√©rification automatique lors de la saisie</li>
            <li>‚úÖ <strong>API getCasePermissions</strong> : Utiliser pour v√©rifier les permissions</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>Simulation du Formulaire de Cr√©ation</h3>
        <button class="simulate-button" onclick="simulateCreateForm()">üìù Simuler le formulaire de cr√©ation</button>
        <div id="form-result"></div>
    </div>

    <div class="test-section">
        <h3>Test des Sc√©narios de Restriction</h3>
        <button class="restriction-button" onclick="testRestrictionScenarios()">üîí Tester les sc√©narios de restriction</button>
        <div id="scenarios-result"></div>
    </div>

    <div class="test-section">
        <h3>Test de l'API getCasePermissions</h3>
        <button class="test-button" onclick="testCasePermissionsAPI()">üîê Tester l'API des permissions</button>
        <div id="api-result"></div>
    </div>

    <div class="test-section">
        <h3>Instructions de Test</h3>
        <div id="instructions-result"></div>
    </div>

    <script>
        function simulateCreateForm() {
            const resultDiv = document.getElementById('form-result');
            
            const currentUser = 'admin';
            
            let html = '<div class="success">';
            html += '<h4>üìù Simulation du formulaire de cr√©ation de rapport</h4>';
            html += '<p>Utilisateur actuel : <span class="user-role">' + currentUser + '</span></p>';
            
            html += '<div class="form-simulation">';
            html += '<h5>Formulaire de cr√©ation de rapport</h5>';
            
            // Message d'information
            html += '<div style="background: #dbeafe; border: 1px solid #93c5fd; border-radius: 4px; padding: 10px; margin: 10px 0; font-size: 12px; color: #1e40af;">';
            html += '<strong>Information :</strong> Vous ne pouvez cr√©er un rapport que pour vos propres dossiers. Entrez le num√©ro de dossier et le syst√®me v√©rifiera automatiquement vos permissions. Tous les champs marqu√©s d\'un * sont obligatoires et doivent correspondre aux informations du dossier s√©lectionn√©. Le fichier du rapport est √©galement obligatoire.';
            html += '</div>';
            
            // Champ titre
            html += '<label style="display: block; margin: 10px 0;">';
            html += '<span style="color: #6b7280; font-size: 12px;">Titre *</span><br>';
            html += '<input type="text" placeholder="Titre du rapport" class="input-field">';
            html += '</label>';
            
            // Champ num√©ro de dossier
            html += '<label style="display: block; margin: 10px 0;">';
            html += '<span style="color: #6b7280; font-size: 12px;">Num√©ro de dossier *</span><br>';
            html += '<input type="text" placeholder="Entrez le num√©ro de dossier" class="input-field">';
            html += '<div class="error-message" style="display: none;">Exemple: Dossier inexistant</div>';
            html += '</label>';
            
            // Statut
            html += '<label style="display: block; margin: 10px 0;">';
            html += '<span style="color: #6b7280; font-size: 12px;">Statut</span><br>';
            html += '<select class="input-field">';
            html += '<option value="DISPONIBLE">Disponible</option>';
            html += '<option value="EN_ATTENTE">En attente</option>';
            html += '<option value="TRAITE">Trait√©</option>';
            html += '</select>';
            html += '</label>';
            
            html += '</div>';
            
            html += '<p><strong>Fonctionnalit√©s impl√©ment√©es :</strong></p>';
            html += '<ul>';
            html += '<li>‚úÖ Champ de saisie libre pour le num√©ro de dossier</li>';
            html += '<li>‚úÖ V√©rification automatique des permissions via getCasePermissions()</li>';
            html += '<li>‚úÖ Message "Dossier inexistant" si le dossier n\'existe pas</li>';
            html += '<li>‚úÖ Message "Permissions insuffisantes" si l\'utilisateur n\'est pas propri√©taire</li>';
            html += '<li>‚úÖ Validation en temps r√©el lors de la saisie</li>';
            html += '</ul>';
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        function testRestrictionScenarios() {
            const resultDiv = document.getElementById('scenarios-result');
            
            let html = '<div class="warning">';
            html += '<h4>üîí Test des sc√©narios de restriction</h4>';
            
            const scenarios = [
                {
                    scenario: 'Utilisateur propri√©taire du dossier',
                    user: 'admin',
                    caseId: 'COBRV8LPS0',
                    caseOwner: 'admin',
                    expected: '‚úÖ Autoris√©',
                    message: 'Aucun message d\'erreur',
                    description: 'L\'utilisateur peut cr√©er un rapport car il est propri√©taire du dossier'
                },
                {
                    scenario: 'Utilisateur non propri√©taire du dossier',
                    user: 'user1',
                    caseId: 'COBRV8LPS0',
                    caseOwner: 'admin',
                    expected: '‚ùå Refus√©',
                    message: 'Permissions insuffisantes. Vous n\'√™tes pas propri√©taire de ce dossier.',
                    description: 'L\'utilisateur ne peut pas cr√©er un rapport car il n\'est pas propri√©taire'
                },
                {
                    scenario: 'Dossier inexistant',
                    user: 'admin',
                    caseId: 'INEXISTANT',
                    caseOwner: 'N/A',
                    expected: '‚ùå Refus√©',
                    message: 'Dossier inexistant',
                    description: 'L\'utilisateur ne peut pas cr√©er un rapport pour un dossier inexistant'
                },
                {
                    scenario: 'Champ vide',
                    user: 'admin',
                    caseId: '',
                    caseOwner: 'N/A',
                    expected: '‚ùå Refus√©',
                    message: 'Aucun message (validation c√¥t√© formulaire)',
                    description: 'Le champ est obligatoire, validation c√¥t√© formulaire'
                }
            ];
            
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<tr style="background: #f8f9fa;"><th style="border: 1px solid #ddd; padding: 8px;">Sc√©nario</th><th style="border: 1px solid #ddd; padding: 8px;">Utilisateur</th><th style="border: 1px solid #ddd; padding: 8px;">Dossier</th><th style="border: 1px solid #ddd; padding: 8px;">Propri√©taire</th><th style="border: 1px solid #ddd; padding: 8px;">R√©sultat</th><th style="border: 1px solid #ddd; padding: 8px;">Message d\'erreur</th><th style="border: 1px solid #ddd; padding: 8px;">Description</th></tr>';
            
            scenarios.forEach(scenario => {
                html += '<tr>';
                html += '<td style="border: 1px solid #ddd; padding: 8px;">' + scenario.scenario + '</td>';
                html += '<td style="border: 1px solid #ddd; padding: 8px;"><span class="user-role">' + scenario.user + '</span></td>';
                html += '<td style="border: 1px solid #ddd; padding: 8px;">' + scenario.caseId + '</td>';
                html += '<td style="border: 1px solid #ddd; padding: 8px;">' + scenario.caseOwner + '</td>';
                html += '<td style="border: 1px solid #ddd; padding: 8px;"><strong>' + scenario.expected + '</strong></td>';
                html += '<td style="border: 1px solid #ddd; padding: 8px;"><span class="error-message">' + scenario.message + '</span></td>';
                html += '<td style="border: 1px solid #ddd; padding: 8px;">' + scenario.description + '</td>';
                html += '</tr>';
            });
            
            html += '</table>';
            
            html += '<p style="margin-top: 15px;"><strong>Logique de validation :</strong></p>';
            html += '<pre>async function validateCaseId(caseId, userName) {
  // 1. V√©rifier si le champ n\'est pas vide
  if (!caseId.trim()) {
    setCaseIdError(\'\');
    return false;
  }
  
  // 2. Rechercher le dossier
  const case = await findCaseByReference(caseId);
  
  if (!case) {
    setCaseIdError(\'Dossier inexistant\');
    return false;
  }
  
  // 3. V√©rifier les permissions
  const permissions = await getCasePermissions(case.id, userName);
  
  if (!permissions.canEdit && !permissions.canDelete) {
    setCaseIdError(\'Permissions insuffisantes. Vous n\'√™tes pas propri√©taire de ce dossier.\');
    return false;
  }
  
  // 4. Autoriser la cr√©ation
  setCaseIdError(\'\');
  return true;
}</pre>';
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        function testCasePermissionsAPI() {
            const resultDiv = document.getElementById('api-result');
            
            let html = '<div class="info">';
            html += '<h4>üîê Test de l\'API getCasePermissions</h4>';
            html += '<p><strong>Endpoint utilis√© :</strong></p>';
            html += '<pre>GET /api/cases/{caseId}/permissions?actorName={userName}</pre>';
            
            html += '<p><strong>R√©ponse attendue :</strong></p>';
            html += '<pre>{
  "canEdit": true,
  "canDelete": true
}</pre>';
            
            html += '<p><strong>Logique de v√©rification :</strong></p>';
            html += '<ul>';
            html += '<li>Si <code>canEdit</code> ou <code>canDelete</code> est <code>true</code> ‚Üí Utilisateur est propri√©taire</li>';
            html += '<li>Si les deux sont <code>false</code> ‚Üí Utilisateur n\'est pas propri√©taire</li>';
            html += '<li>En cas d\'erreur ‚Üí Afficher un message d\'erreur</li>';
            html += '</ul>';
            
            html += '<p><strong>Messages d\'erreur sp√©cifiques :</strong></p>';
            html += '<ul>';
            html += '<li><span class="error-message">Dossier inexistant</span> - Si le dossier n\'existe pas dans la base de donn√©es</li>';
            html += '<li><span class="error-message">Permissions insuffisantes. Vous n\'√™tes pas propri√©taire de ce dossier.</span> - Si l\'utilisateur n\'est pas propri√©taire</li>';
            html += '<li><span class="error-message">Erreur lors de la v√©rification des permissions du dossier</span> - En cas d\'erreur technique</li>';
            html += '</ul>';
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        function showInstructions() {
            const resultDiv = document.getElementById('instructions-result');
            
            let html = '<div class="info">';
            html += '<h4>üîç Instructions de test</h4>';
            html += '<p><strong>Pour tester la nouvelle restriction de propri√©t√© des dossiers :</strong></p>';
            html += '<ol>';
            html += '<li><strong>Red√©marrez votre backend</strong> pour que les modifications soient prises en compte</li>';
            html += '<li><strong>Lancez votre frontend</strong></li>';
            html += '<li><strong>Connectez-vous avec un utilisateur</strong> qui a des dossiers</li>';
            html += '<li><strong>Allez sur la page "Rapports"</strong></li>';
            html += '<li><strong>Cliquez sur "Ajouter un rapport"</strong></li>';
            html += '<li><strong>Testez les diff√©rents sc√©narios :</strong></li>';
            html += '<ul>';
            html += '<li><strong>Dossier valide et propri√©taire</strong> : Entrez un num√©ro de dossier dont vous √™tes propri√©taire</li>';
            html += '<li><strong>Dossier inexistant</strong> : Entrez un num√©ro de dossier qui n\'existe pas ‚Üí "Dossier inexistant"</li>';
            html += '<li><strong>Dossier d\'un autre utilisateur</strong> : Entrez un num√©ro de dossier d\'un autre utilisateur ‚Üí "Permissions insuffisantes"</li>';
            html += '<li><strong>Champ vide</strong> : Laissez le champ vide ‚Üí Validation c√¥t√© formulaire</li>';
            html += '</ul>';
            html += '<li><strong>V√©rifiez les messages d\'erreur</strong> qui s\'affichent en temps r√©el</li>';
            html += '<li><strong>V√©rifiez les logs dans la console</strong> pour voir les appels API</li>';
            html += '</ol>';
            
            html += '<p><strong>Fonctionnalit√©s √† v√©rifier :</strong></p>';
            html += '<ul>';
            html += '<li>‚úÖ Champ de saisie libre pour le num√©ro de dossier</li>';
            html += '<li>‚úÖ Validation en temps r√©el lors de la saisie</li>';
            html += '<li>‚úÖ Message "Dossier inexistant" pour les dossiers inexistants</li>';
            html += '<li>‚úÖ Message "Permissions insuffisantes" pour les non-propri√©taires</li>';
            html += '<li>‚úÖ V√©rification des permissions via getCasePermissions()</li>';
            html += '<li>‚úÖ Gestion des cas d\'erreur technique</li>';
            html += '</ul>';
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        // Charger les instructions au chargement de la page
        window.onload = function() {
            showInstructions();
        };
    </script>
</body>
</html>
