<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test T√©l√©chargement - Correction</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        .result { margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîß Test de Correction du Syst√®me de T√©l√©chargement</h1>
    
    <div class="test-section info">
        <h3>üìã Informations sur la correction</h3>
        <p><strong>Probl√®me identifi√© :</strong> Incoh√©rence entre frontend et backend pour la g√©n√©ration des codes d'acc√®s</p>
        <ul>
            <li><strong>Frontend :</strong> G√©n√®re le code bas√© sur l'ID du rapport (CODE000001)</li>
            <li><strong>Backend (avant correction) :</strong> G√©n√®re le code bas√© sur l'ID du fichier (CODE000002)</li>
            <li><strong>Backend (apr√®s correction) :</strong> G√©n√®re le code bas√© sur l'ID du rapport (CODE000001)</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>üß™ Test 1 : Validation du Code d'Acc√®s</h3>
        <p>Test de l'endpoint de validation avec un code g√©n√©r√© bas√© sur l'ID du rapport</p>
        
        <label>ID du Rapport: <input type="number" id="reportId" value="1" min="1"></label><br>
        <label>Code d'Acc√®s: <input type="text" id="accessCode" placeholder="Ex: CODE000001"></label><br>
        
        <button onclick="testCodeValidation()">Tester la Validation</button>
        <button onclick="generateCode()">G√©n√©rer le Code</button>
        
        <div id="validationResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h3>üì• Test 2 : T√©l√©chargement S√©curis√©</h3>
        <p>Test du t√©l√©chargement avec validation du code d'acc√®s</p>
        
        <label>ID du Rapport: <input type="number" id="downloadReportId" value="1" min="1"></label><br>
        <label>Nom de l'Utilisateur: <input type="text" id="requesterName" value="testuser"></label><br>
        <label>Code d'Acc√®s: <input type="text" id="downloadCode" placeholder="Ex: CODE000001"></label><br>
        
        <button onclick="testSecureDownload()">Tester le T√©l√©chargement</button>
        <button onclick="testDemoDownload()">Tester T√©l√©chargement Demo (sans code)</button>
        
        <div id="downloadResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h3>üìã Test 3 : R√©cup√©ration des Fichiers avec Codes</h3>
        <p>Test de r√©cup√©ration des fichiers d'un rapport avec leurs codes d'acc√®s</p>
        
        <label>ID du Rapport: <input type="number" id="filesReportId" value="1" min="1"></label><br>
        <label>Nom de l'Utilisateur: <input type="text" id="filesRequesterName" value="admin"></label><br>
        
        <button onclick="testGetFilesWithCodes()">R√©cup√©rer les Fichiers</button>
        
        <div id="filesResult" class="result" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';

        function generateCode() {
            const reportId = document.getElementById('reportId').value;
            const code = `CODE${reportId.toString().padStart(6, '0')}`;
            document.getElementById('accessCode').value = code;
        }

        async function testCodeValidation() {
            const reportId = document.getElementById('reportId').value;
            const code = document.getElementById('accessCode').value;
            const resultDiv = document.getElementById('validationResult');
            
            try {
                const response = await fetch(`${API_BASE}/api/download/validate-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId: parseInt(reportId), code: code })
                });
                
                const data = await response.json();
                
                resultDiv.style.display = 'block';
                if (data.valid) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Validation r√©ussie</h4>
                        <p><strong>Code fourni:</strong> ${code}</p>
                        <p><strong>Code attendu:</strong> ${data.expectedCode}</p>
                        <p><strong>Type d'ID:</strong> ${data.idType}</p>
                        <p><strong>ID utilis√©:</strong> ${data.id}</p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>‚ùå Validation √©chou√©e</h4>
                        <p><strong>Code fourni:</strong> ${code}</p>
                        <p><strong>Code attendu:</strong> ${data.expectedCode}</p>
                        <p><strong>Erreur:</strong> ${data.error || 'Code invalide'}</p>
                    `;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Erreur</h4><p>${error.message}</p>`;
            }
        }

        async function testSecureDownload() {
            const reportId = document.getElementById('downloadReportId').value;
            const requesterName = document.getElementById('requesterName').value;
            const code = document.getElementById('downloadCode').value;
            const resultDiv = document.getElementById('downloadResult');
            
            try {
                const response = await fetch(`${API_BASE}/api/download/${reportId}?requesterName=${encodeURIComponent(requesterName)}&code=${encodeURIComponent(code)}`);
                
                resultDiv.style.display = 'block';
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ T√©l√©chargement r√©ussi</h4>
                        <p>Le fichier devrait se t√©l√©charger automatiquement.</p>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Content-Type:</strong> ${response.headers.get('content-type')}</p>
                    `;
                    
                    // D√©clencher le t√©l√©chargement
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rapport_${reportId}.bin`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    const errorText = await response.text();
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>‚ùå T√©l√©chargement √©chou√©</h4>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Erreur:</strong> ${errorText}</p>
                    `;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Erreur</h4><p>${error.message}</p>`;
            }
        }

        async function testDemoDownload() {
            const reportId = document.getElementById('downloadReportId').value;
            const requesterName = document.getElementById('requesterName').value;
            const resultDiv = document.getElementById('downloadResult');
            
            try {
                const response = await fetch(`${API_BASE}/api/download/demo/${reportId}?requesterName=${encodeURIComponent(requesterName)}`);
                
                resultDiv.style.display = 'block';
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ T√©l√©chargement Demo r√©ussi</h4>
                        <p>Le fichier devrait se t√©l√©charger automatiquement (sans validation de code).</p>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Content-Type:</strong> ${response.headers.get('content-type')}</p>
                    `;
                    
                    // D√©clencher le t√©l√©chargement
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rapport_demo_${reportId}.bin`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    const errorText = await response.text();
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>‚ùå T√©l√©chargement Demo √©chou√©</h4>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Erreur:</strong> ${errorText}</p>
                    `;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Erreur</h4><p>${error.message}</p>`;
            }
        }

        async function testGetFilesWithCodes() {
            const reportId = document.getElementById('filesReportId').value;
            const requesterName = document.getElementById('filesRequesterName').value;
            const resultDiv = document.getElementById('filesResult');
            
            try {
                const response = await fetch(`${API_BASE}/api/download/files/${reportId}?requesterName=${encodeURIComponent(requesterName)}`);
                
                resultDiv.style.display = 'block';
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Fichiers r√©cup√©r√©s avec succ√®s</h4>
                        <p><strong>Nombre de fichiers:</strong> ${data.length}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    const errorText = await response.text();
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>‚ùå √âchec de r√©cup√©ration des fichiers</h4>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Erreur:</strong> ${errorText}</p>
                    `;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Erreur</h4><p>${error.message}</p>`;
            }
        }

        // G√©n√©rer automatiquement le code au chargement
        window.onload = function() {
            generateCode();
        };
    </script>
</body>
</html>
