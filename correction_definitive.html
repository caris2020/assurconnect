<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correction D√©finitive - Dates d'Expiration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background-color: #dc3545;
            color: white;
            padding: 20px 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            margin: 10px;
            font-weight: bold;
        }
        .button:hover {
            background-color: #c82333;
        }
        .success {
            background-color: #28a745;
        }
        .success:hover {
            background-color: #218838;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 5px;
            font-size: 16px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .success-result {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .steps {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
        .step.completed {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Correction D√©finitive - Dates d'Expiration</h1>
        <p><strong>Probl√®me identifi√© :</strong> Les utilisateurs ont des dates futures (28/08/2026) mais affichent "Expire aujourd'hui".</p>
        
        <div class="steps">
            <h3>üìã √âtapes de Correction :</h3>
            <div id="step1" class="step">
                1Ô∏è‚É£ V√©rifier la connexion au backend
            </div>
            <div id="step2" class="step">
                2Ô∏è‚É£ Diagnostiquer les incoh√©rences
            </div>
            <div id="step3" class="step">
                3Ô∏è‚É£ Corriger automatiquement les donn√©es
            </div>
            <div id="step4" class="step">
                4Ô∏è‚É£ V√©rifier la correction
            </div>
        </div>
        
        <div>
            <button class="button" onclick="startCorrection()">üöÄ D√âMARRER LA CORRECTION D√âFINITIVE</button>
            <button class="button success" onclick="checkStatus()">üîç V√©rifier le Statut Final</button>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        
        function updateStep(stepNumber, completed) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            if (completed) {
                stepElement.classList.add('completed');
                stepElement.innerHTML += ' ‚úÖ';
            }
        }
        
        async function startCorrection() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result warning">üöÄ D√©marrage de la correction d√©finitive...</div>';
            
            try {
                // √âtape 1: V√©rifier la connexion
                updateStep(1, true);
                resultDiv.innerHTML = '<div class="result">‚úÖ Connexion v√©rifi√©e<br>üîç Diagnostic en cours...</div>';
                
                // √âtape 2: Diagnostiquer
                const diagnosticResponse = await fetch(`${API_BASE}/subscriptions/debug-dates`);
                if (!diagnosticResponse.ok) {
                    throw new Error('Impossible de diagnostiquer les dates');
                }
                const diagnosticData = await diagnosticResponse.json();
                updateStep(2, true);
                
                let inconsistentCount = 0;
                diagnosticData.users.forEach(user => {
                    if (user.isInconsistent || 
                        (user.daysUntilExpiration === 0 && user.subscriptionEndDate && 
                         new Date(user.subscriptionEndDate) > new Date())) {
                        inconsistentCount++;
                    }
                });
                
                resultDiv.innerHTML = `<div class="result">
‚úÖ Diagnostic termin√©<br>
üìä ${inconsistentCount} incoh√©rences d√©tect√©es<br>
üîß Correction en cours...
</div>`;
                
                // √âtape 3: Corriger
                updateStep(3, true);
                const fixResponse = await fetch(`${API_BASE}/subscriptions/fix-dates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const fixData = await fixResponse.json();
                
                if (fixData.success) {
                    updateStep(4, true);
                    resultDiv.innerHTML = `<div class="result success-result">
üéâ <strong>CORRECTION D√âFINITIVE R√âUSSIE !</strong>
<p>‚úÖ ${fixData.message}</p>
<p>üìä Utilisateurs corrig√©s: ${fixData.correctedCount}</p>
<p>üìÖ Date syst√®me: ${fixData.currentDate}</p>
<hr>
<p><strong>üéØ Actions requises :</strong></p>
<p>1Ô∏è‚É£ Actualisez la page du tableau de bord administrateur</p>
<p>2Ô∏è‚É£ Allez dans l'onglet "Utilisateurs"</p>
<p>3Ô∏è‚É£ V√©rifiez que les dates futures (2026) sont maintenant en <strong>VERT</strong></p>
<p>4Ô∏è‚É£ V√©rifiez que le texte affiche "365 jours restants" au lieu de "Expire aujourd'hui"</p>
</div>`;
                } else {
                    throw new Error(fixData.message);
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">
‚ùå <strong>Erreur lors de la correction d√©finitive</strong>
<p>${error.message}</p>
<p><strong>Solutions possibles :</strong></p>
<p>1Ô∏è‚É£ Assurez-vous que le backend est d√©marr√© sur http://localhost:8080</p>
<p>2Ô∏è‚É£ V√©rifiez que la base de donn√©es est accessible</p>
<p>3Ô∏è‚É£ Red√©marrez le backend si n√©cessaire</p>
</div>`;
            }
        }
        
        async function checkStatus() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">üîç V√©rification du statut final...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/subscriptions/debug-dates`);
                const data = await response.json();
                
                let inconsistentCount = 0;
                data.users.forEach(user => {
                    if (user.isInconsistent || 
                        (user.daysUntilExpiration === 0 && user.subscriptionEndDate && 
                         new Date(user.subscriptionEndDate) > new Date())) {
                        inconsistentCount++;
                    }
                });
                
                if (inconsistentCount === 0) {
                    resultDiv.innerHTML = `<div class="result success-result">
üéâ <strong>STATUT FINAL : CORRECTION R√âUSSIE !</strong>
<p>‚úÖ Aucune incoh√©rence d√©tect√©e</p>
<p>‚úÖ Tous les abonnements sont coh√©rents</p>
<p>‚úÖ Les dates futures affichent correctement les jours restants</p>
<p>üìÖ Date syst√®me: ${data.currentDate}</p>
<hr>
<p><strong>üéØ Probl√®me r√©solu !</strong></p>
<p>Vous pouvez maintenant utiliser le tableau de bord administrateur normalement.</p>
</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="result error">
‚ö†Ô∏è <strong>STATUT FINAL : INCOH√âRENCES PERSISTANTES</strong>
<p>‚ùå ${inconsistentCount} incoh√©rences d√©tect√©es</p>
<p>üîÑ Relancez la correction d√©finitive</p>
</div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">
‚ùå <strong>Erreur de v√©rification</strong>
<p>${error.message}</p>
</div>`;
            }
        }
        
        // V√©rification automatique au chargement
        window.onload = function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result warning">
üîß <strong>Outil de Correction D√©finitive</strong>
<p>Cliquez sur "D√âMARRER LA CORRECTION D√âFINITIVE" pour r√©soudre imm√©diatement le probl√®me des dates d'expiration.</p>
<p>Cet outil va :</p>
<ul>
<li>Diagnostiquer toutes les incoh√©rences</li>
<li>Corriger automatiquement les donn√©es</li>
<li>V√©rifier que la correction est effective</li>
</ul>
</div>`;
        };
    </script>
</body>
</html>
